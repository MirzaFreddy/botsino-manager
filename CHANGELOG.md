# 📝 تاریخچه تغییرات Botsino Manager

## نسخه 2.0.1 - Oct 19, 2025

### ✅ رفع خطاها

#### 1. خطای "Cannot access protected property"
**مشکل:** در `QueueManager.php` خط 153، دسترسی مستقیم به property محافظت شده `$api` کلاس `UserManager`

**راه حل:**
```php
// قبل (اشتباه)
$current_user = $this->user_manager->api->get_user($user_data['email']);

// بعد (صحیح)
$api_client = new \BotsinoManager\API\APIClient();
$current_user = $api_client->get_user($user_data['email']);
```

**فایل:** `includes/Queue/QueueManager.php`

---

#### 2. خطای "Undefined array key 'success'"
**مشکل:** متد `get_users()` در `APIClient` مستقیماً آرایه کاربران را برمی‌گرداند نه آرایه با کلید `success`

**راه حل:**
```php
// قبل (اشتباه)
if (!$result['success'] || empty($result['data'])) { }

// بعد (صحیح)
if (empty($users)) { }
```

**فایل:** `includes/Admin/Views/MainPage.php`

---

### 🚀 ویژگی‌های جدید

#### 1. ارسال فوری پیام اطلاعات ورود
**قبل:** پیام دوم (اطلاعات ورود) به صف اضافه می‌شد و ممکن بود دیر ارسال شود یا اصلاً ارسال نشود

**بعد:** پیام‌ها به صورت فوری و متوالی ارسال می‌شوند:

**جریان ارسال پیام‌ها:**
1. **پیام اول** (تایید): بلافاصله با `send_instant_confirmation()`
2. **تاخیر 3 ثانیه** برای اطمینان از ارسال پیام اول
3. **پیام دوم** (اطلاعات ورود): با `send_credentials_immediately()`

**تغییرات:**
```php
// در UserManager.php
protected function send_credentials_immediately($phone, $fullname, $username, $password) {
    // تاخیر 3 ثانیه برای اطمینان از ارسال پیام اول
    sleep(3);
    
    require_once BOTSINO_PLUGIN_DIR . 'includes/Notifications/WhatsAppSender.php';
    $whatsapp = new \BotsinoManager\Notifications\WhatsAppSender();
    
    error_log("Sending credentials immediately - Phone: {$phone}");
    
    return $whatsapp->send_credentials($phone, $fullname, $username, $password);
}
```

**مزایا:**
- ✅ پیام دوم حتماً ارسال می‌شود
- ✅ زمان ارسال قابل پیش‌بینی است (3 ثانیه بعد از پیام اول)
- ✅ نیازی به پردازش صف نیست
- ✅ تجربه کاربری بهتر

---

#### 2. بهبود صفحه صف کاربران

**امکانات جدید:**

##### ✅ انتخاب دسته‌ای
- چک باکس "انتخاب همه" در header جدول
- چک باکس برای هر ردیف
- JavaScript برای مدیریت انتخاب همه

##### ✅ حذف دسته‌ای
- دکمه "🗑️ حذف موارد انتخابی"
- تایید قبل از حذف
- نمایش تعداد موارد انتخاب شده

##### ✅ ارسال مجدد اطلاعات
- دکمه "📨" برای موارد تکمیل شده
- دریافت اطلاعات جدید از API
- ارسال مجدد username و password

##### ✅ نمایش اطلاعات کامل
- ایمیل کاربر
- شماره تلفن
- شماره پلن
- وضعیت با Badge رنگی
- تاریخ و ساعت

##### ✅ وضعیت‌های رنگی
- 🟢 **تکمیل شده:** سبز روشن
- 🟡 **در انتظار:** زرد روشن
- 🔵 **در حال پردازش:** آبی روشن
- 🔴 **خطا:** قرمز روشن

##### ✅ دکمه‌های عملیاتی
- 🔄 تلاش مجدد (برای موارد failed/pending)
- 📨 ارسال مجدد (برای موارد completed)
- 🗑️ حذف تک تک

##### ✅ آمار زنده
نمایش آمار در پایین صفحه:
- کل موارد
- موارد در انتظار
- موارد تکمیل شده
- موارد با خطا

**کد JavaScript:**
```javascript
$("#select-all").on("change", function() {
    $(".queue-checkbox").prop("checked", $(this).prop("checked"));
});

$("#delete-selected").on("click", function() {
    var selected = $(".queue-checkbox:checked").length;
    if (selected === 0) {
        alert("لطفاً حداقل یک مورد را انتخاب کنید");
        return;
    }
    
    if (confirm("آیا از حذف " + selected + " مورد مطمئن هستید؟")) {
        $("#queue-form").submit();
    }
});
```

---

### 📊 مقایسه قبل و بعد

#### صفحه Queue

**قبل:**
```
┌─────────────────────────────────────┐
│ ID | سفارش | وضعیت | تاریخ | حذف  │
├─────────────────────────────────────┤
│ 1  | 123   | pending| ... | [حذف] │
└─────────────────────────────────────┘
```

**بعد:**
```
┌──────────────────────────────────────────────────────────────────┐
│ ☑ | ID | سفارش | ایمیل | تلفن | پلن | وضعیت | تاریخ | عملیات │
├──────────────────────────────────────────────────────────────────┤
│ ☐ | 1  | #123  | a@... | 0912...| پلن2| ⏳ در انتظار | ... | 🔄 🗑️ │
│ ☐ | 2  | #124  | b@... | 0913...| پلن3| ✅ تکمیل   | ... | 📨 🗑️ │
└──────────────────────────────────────────────────────────────────┘
[⚡ اجرای صف] [🗑️ حذف موارد انتخابی]

آمار: کل: 50 | ⏳ در انتظار: 10 | ✅ تکمیل: 35 | ❌ خطا: 5
```

#### ارسال پیام‌ها

**قبل:**
1. کاربر وارد شماره می‌کند
2. ✅ پیام اول فوری ارسال می‌شود
3. ❌ پیام دوم به صف اضافه می‌شود
4. ⏰ منتظر cron job (هر 5 دقیقه)
5. ❓ ممکن است ارسال نشود

**بعد:**
1. کاربر وارد شماره می‌کند
2. ✅ پیام اول فوری ارسال می‌شود (0 ثانیه)
3. ⏱️ تاخیر 3 ثانیه
4. ✅ پیام دوم فوری ارسال می‌شود (3 ثانیه)
5. ✅ کاربر هر دو پیام را دریافت می‌کند

---

### 🔧 تغییرات فنی

#### فایل‌های تغییر یافته:

1. **includes/Queue/QueueManager.php**
   - رفع خطای دسترسی به property محافظت شده
   - استفاده از APIClient جدید

2. **includes/Users/UserManager.php**
   - حذف استفاده از صف برای پیام اطلاعات
   - افزودن متد `send_credentials_immediately()`
   - تاخیر 3 ثانیه بین دو پیام

3. **includes/Admin/Views/MainPage.php**
   - رفع خطای Undefined array key
   - بازنویسی کامل `render_queue_tab()`
   - افزودن متدهای:
     - `resend_credentials()` - ارسال مجدد اطلاعات
     - `bulk_delete_queue()` - حذف دسته‌ای
   - افزودن JavaScript برای انتخاب دسته‌ای
   - افزودن استایل‌های جدید

---

### 📋 چک‌لیست تست

- [x] پیام اول بلافاصله ارسال می‌شود
- [x] پیام دوم 3 ثانیه بعد ارسال می‌شود
- [x] هر دو پیام با موفقیت دریافت می‌شوند
- [x] صف کاربران اطلاعات کامل نمایش می‌دهد
- [x] انتخاب همه کار می‌کند
- [x] حذف دسته‌ای کار می‌کند
- [x] ارسال مجدد اطلاعات کار می‌کند
- [x] وضعیت‌های رنگی صحیح نمایش داده می‌شوند
- [x] آمار صحیح است
- [x] هیچ خطایی در لاگ نیست

---

### 🚀 نحوه استفاده

#### ارسال مجدد اطلاعات:
1. به صفحه صف کاربران بروید
2. موارد تکمیل شده دکمه "📨" دارند
3. کلیک روی دکمه
4. پیام اطلاعات ورود مجدداً ارسال می‌شود

#### حذف دسته‌ای:
1. چک باکس‌های مورد نظر را انتخاب کنید
2. روی "🗑️ حذف موارد انتخابی" کلیک کنید
3. تایید کنید
4. موارد حذف می‌شوند

#### بررسی وضعیت:
- 🟢 **تکمیل شده:** پردازش موفق
- 🟡 **در انتظار:** منتظر پردازش
- 🔵 **در حال پردازش:** در حال انجام
- 🔴 **خطا:** نیاز به بررسی

---

### ⚠️ نکات مهم

1. **تاخیر 3 ثانیه** بین دو پیام اجباری است تا اطمینان حاصل شود پیام اول ارسال شده
2. **ارسال فوری** ممکن است باعث افزایش زمان پردازش سفارش شود (حدود 5-6 ثانیه)
3. **حذف دسته‌ای** برگشت‌پذیر نیست - با احتیاط استفاده کنید
4. **ارسال مجدد** فقط برای موارد تکمیل شده امکان‌پذیر است

---

### 📞 پشتیبانی

در صورت بروز مشکل:
1. لاگ‌ها را بررسی کنید: `wp-content/debug.log`
2. وضعیت صف را در پنل مدیریت چک کنید
3. از دکمه "اجرای دستی" برای تست استفاده کنید

---

## نسخه 2.0.0 - Oct 18, 2025

### 🎉 بازنویسی کامل
- Refactoring از 4804 خط به ساختار ماژولار
- PSR-4 Autoloading
- معماری حرفه‌ای
- جداسازی مسئولیت‌ها

(جزئیات در README.md)
